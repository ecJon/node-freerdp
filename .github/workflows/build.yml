name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  FREERDP_VERSION: 3.22.0

jobs:
  build-mac-x64:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          brew install openssl@3

      - name: Build FreeRDP static
        run: |
          git clone --branch 3.22.0 --depth 1 https://github.com/FreeRDP/FreeRDP.git
          cd FreeRDP
          mkdir build && cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/freerdp-static \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_TESTING=OFF \
            -DWITH_SERVER=OFF \
            -DWITH_CLIENT=ON \
            -DWITH_SAMPLE=OFF \
            -DWITH_CLIENT_SDL=OFF \
            -DWITH_X11=OFF \
            -DWITH_CUPS=OFF \
            -DWITH_PCSC=OFF \
            -DWITH_PKCS11=OFF \
            -DWITH_SMARTCARD_EMULATE=OFF \
            -DWITH_SMARTCARD_PCSC=OFF \
            -DWITH_FFMPEG=OFF \
            -DWITH_SWSCALE=OFF \
            -DWITH_GFX_H264=OFF \
            -DWITH_VIDEO_FFMPEG=OFF \
            -DWITH_DSP_FFMPEG=OFF \
            -DWITH_JPEG=OFF \
            -DWITH_WEBVIEW=OFF \
            -DWITH_AAD=OFF \
            -DWITH_LODEPNG=OFF \
            -DWITH_DEBUG_ALL=OFF \
            -DWITH_SDL=OFF \
            -DWITH_OPUS=OFF \
            -DWITH_OPENSSL=ON \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Update binding.gyp paths
        run: |
          sed -i '' "s|/Users/ecjon/freerdp-static|${{ github.workspace }}/freerdp-static|g" binding.gyp
          sed -i '' "s|/opt/homebrew/opt/openssl@3|$(brew --prefix openssl@3)|g" binding.gyp

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build node addon
        run: |
          npm install
          npm run install

      - name: Create package
        run: |
          mkdir -p dist/macos-x64
          cp build/Release/node-freerdp.node dist/macos-x64/
          cp README.md LICENSE dist/macos-x64/ 2>/dev/null || true
          cd dist/macos-x64
          cat > package.json << 'EOF'
          {
            "name": "node-freerdp",
            "version": "${{ github.ref_name }}",
            "os": "darwin",
            "arch": "x64",
            "main": "node-freerdp.node"
          }
          EOF
          tar czf ../node-freerdp-macos-x64.tar.gz .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: node-freerdp-macos-x64
          path: dist/node-freerdp-macos-x64.tar.gz

  build-mac-arm:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          brew install openssl@3

      - name: Build FreeRDP static
        run: |
          git clone --branch 3.22.0 --depth 1 https://github.com/FreeRDP/FreeRDP.git
          cd FreeRDP
          mkdir build && cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/freerdp-static \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_TESTING=OFF \
            -DWITH_SERVER=OFF \
            -DWITH_CLIENT=ON \
            -DWITH_SAMPLE=OFF \
            -DWITH_CLIENT_SDL=OFF \
            -DWITH_X11=OFF \
            -DWITH_CUPS=OFF \
            -DWITH_PCSC=OFF \
            -DWITH_PKCS11=OFF \
            -DWITH_SMARTCARD_EMULATE=OFF \
            -DWITH_SMARTCARD_PCSC=OFF \
            -DWITH_FFMPEG=OFF \
            -DWITH_SWSCALE=OFF \
            -DWITH_GFX_H264=OFF \
            -DWITH_VIDEO_FFMPEG=OFF \
            -DWITH_DSP_FFMPEG=OFF \
            -DWITH_JPEG=OFF \
            -DWITH_WEBVIEW=OFF \
            -DWITH_AAD=OFF \
            -DWITH_LODEPNG=OFF \
            -DWITH_DEBUG_ALL=OFF \
            -DWITH_SDL=OFF \
            -DWITH_OPUS=OFF \
            -DWITH_OPENSSL=ON \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Update binding.gyp paths
        run: |
          sed -i '' "s|/Users/ecjon/freerdp-static|${{ github.workspace }}/freerdp-static|g" binding.gyp
          sed -i '' "s|/opt/homebrew/opt/openssl@3|$(brew --prefix openssl@3)|g" binding.gyp

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build node addon
        run: |
          npm install
          npm run install

      - name: Create package
        run: |
          mkdir -p dist/macos-arm64
          cp build/Release/node-freerdp.node dist/macos-arm64/
          cp README.md dist/macos-arm64/ 2>/dev/null || true
          cd dist/macos-arm64
          cat > package.json << 'EOF'
          {
            "name": "node-freerdp",
            "version": "${{ github.ref_name }}",
            "os": "darwin",
            "arch": "arm64",
            "main": "node-freerdp.node"
          }
          EOF
          tar czf ../node-freerdp-macos-arm64.tar.gz .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: node-freerdp-macos-arm64
          path: dist/node-freerdp-macos-arm64.tar.gz

  build-linux-x64:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            cmake \
            libssl-dev \
            libx11-dev \
            libxext-dev \
            libxrender-dev \
            libxtst-dev \
            libxi-dev \
            libxkbfile-dev \
            libxv-dev \
            libxinerama-dev \
            libxcursor-dev \
            libusb-1.0-0-dev

      - name: Build FreeRDP static
        run: |
          git clone --branch 3.22.0 --depth 1 https://github.com/FreeRDP/FreeRDP.git
          cd FreeRDP
          mkdir build && cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/freerdp-static \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_TESTING=OFF \
            -DWITH_SERVER=OFF \
            -DWITH_CLIENT=ON \
            -DWITH_SAMPLE=OFF \
            -DWITH_CLIENT_SDL=OFF \
            -DWITH_X11=ON \
            -DWAYLAND=OFF \
            -DWITH_CUPS=OFF \
            -DWITH_PCSC=OFF \
            -DWITH_PKCS11=OFF \
            -DWITH_SMARTCARD_EMULATE=OFF \
            -DWITH_SMARTCARD_PCSC=OFF \
            -DWITH_FFMPEG=OFF \
            -DWITH_SWSCALE=OFF \
            -DWITH_GFX_H264=OFF \
            -DWITH_VIDEO_FFMPEG=OFF \
            -DWITH_DSP_FFMPEG=OFF \
            -DWITH_JPEG=OFF \
            -DWITH_WEBVIEW=OFF \
            -DWITH_AAD=OFF \
            -DWITH_LODEPNG=OFF \
            -DWITH_DEBUG_ALL=OFF \
            -DWITH_SDL=OFF \
            -DWITH_OPUS=OFF \
            -DWITH_OPENSSL=ON
          make -j$(nproc)
          make install

      - name: Update binding.gyp for Linux
        run: |
          cat > binding.gyp << 'EOF'
          {
              "targets": [
                  {
                      "target_name": "node-freerdp",
                      "sources": ["context.cc", "generator.cc", "rdp.cc", "bridge.cc", "node-freerdp.cc"],
                      "include_dirs": [
                          "<!(node -e \"require('nan')\")",
                          "${{ github.workspace }}/freerdp-static/include/freerdp3",
                          "${{ github.workspace }}/freerdp-static/include/winpr3"
                      ],
                      "libraries": [
                          "${{ github.workspace }}/freerdp-static/lib/libfreerdp-client3.a",
                          "${{ github.workspace }}/freerdp-static/lib/libfreerdp3.a",
                          "${{ github.workspace }}/freerdp-static/lib/libwinpr3.a",
                          "-lssl",
                          "-lcrypto",
                          "-lX11",
                          "-lXext",
                          "-lXrender",
                          "-lXtst",
                          "-lXi",
                          "-lxkbfile",
                          "-lXv",
                          "-lXinerama",
                          "-lXcursor",
                          "-lusb-1.0",
                          "-lz",
                          "-lpthread",
                          "-lm",
                          "-lrt"
                      ]
                  }
              ]
          }
          EOF

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build node addon
        run: |
          npm install
          npm run install

      - name: Create package
        run: |
          mkdir -p dist/linux-x64
          cp build/Release/node-freerdp.node dist/linux-x64/
          cp README.md dist/linux-x64/ 2>/dev/null || true
          cd dist/linux-x64
          cat > package.json << 'EOF'
          {
            "name": "node-freerdp",
            "version": "${{ github.ref_name }}",
            "os": "linux",
            "arch": "x64",
            "main": "node-freerdp.node"
          }
          EOF
          tar czf ../node-freerdp-linux-x64.tar.gz .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: node-freerdp-linux-x64
          path: dist/node-freerdp-linux-x64.tar.gz

  build-linux-arm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build in Docker
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            --platform linux/arm64 \
            ubuntu:22.04 \
            bash -c "
              apt-get update && \
              apt-get install -y build-essential git cmake libssl-dev nodejs npm && \
              git clone --branch 3.22.0 --depth 1 https://github.com/FreeRDP/FreeRDP.git && \
              cd FreeRDP && mkdir build && cd build && \
              cmake .. \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX=/workspace/freerdp-static \
                -DBUILD_SHARED_LIBS=OFF \
                -DBUILD_TESTING=OFF \
                -DWITH_SERVER=OFF \
                -DWITH_CLIENT=ON \
                -DWITH_SAMPLE=OFF \
                -DWITH_CLIENT_SDL=OFF \
                -DWITH_X11=OFF \
                -DWITH_CUPS=OFF \
                -DWITH_PCSC=OFF \
                -DWITH_PKCS11=OFF \
                -DWITH_SMARTCARD_EMULATE=OFF \
                -DWITH_SMARTCARD_PCSC=OFF \
                -DWITH_FFMPEG=OFF \
                -DWITH_SWSCALE=OFF \
                -DWITH_GFX_H264=OFF \
                -DWITH_VIDEO_FFMPEG=OFF \
                -DWITH_DSP_FFMPEG=OFF \
                -DWITH_JPEG=OFF \
                -DWITH_WEBVIEW=OFF \
                -DWITH_AAD=OFF \
                -DWITH_LODEPNG=OFF \
                -DWITH_DEBUG_ALL=OFF \
                -DWITH_SDL=OFF \
                -DWITH_OPUS=OFF \
                -DWITH_OPENSSL=ON && \
              make -j\$(nproc) && \
              make install && \
              cd /workspace && \
              cat > binding.gyp << 'GYP_EOF'
          {
              \"targets\": [{
                  \"target_name\": \"node-freerdp\",
                  \"sources\": [\"context.cc\", \"generator.cc\", \"rdp.cc\", \"bridge.cc\", \"node-freerdp.cc\"],
                  \"include_dirs\": [
                      \"<!(node -e \\\"require('nan')\\\")\",
                      \"/workspace/freerdp-static/include/freerdp3\",
                      \"/workspace/freerdp-static/include/winpr3\"
                  ],
                  \"libraries\": [
                      \"/workspace/freerdp-static/lib/libfreerdp-client3.a\",
                      \"/workspace/freerdp-static/lib/libfreerdp3.a\",
                      \"/workspace/freerdp-static/lib/libwinpr3.a\",
                      \"-lssl\", \"-lcrypto\", \"-lz\", \"-lpthread\", \"-lm\", \"-lrt\"
                  ]
              }]
          }
          GYP_EOF
              npm install && \
              npm run install && \
              mkdir -p dist/linux-arm64 && \
              cp build/Release/node-freerdp.node dist/linux-arm64/ && \
              cd dist/linux-arm64 && \
              echo '{\"name\":\"node-freerdp\",\"version\":\"${{ github.ref_name }}\",\"os\":\"linux\",\"arch\":\"arm64\",\"main\":\"node-freerdp.node\"}' > package.json && \
              tar czf /workspace/node-freerdp-linux-arm64.tar.gz .
            "

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: node-freerdp-linux-arm64
          path: node-freerdp-linux-arm64.tar.gz

  build-windows-x64:
    runs-on: windows-2019
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          choco install openssl -y
          choco install cmake -y

      - name: Build FreeRDP static
        run: |
          git clone --branch 3.22.0 --depth 1 https://github.com/FreeRDP/FreeRDP.git
          cd FreeRDP
          mkdir build
          cd build
          cmake .. `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}\freerdp-static" `
            -DBUILD_SHARED_LIBS=OFF `
            -DBUILD_TESTING=OFF `
            -DWITH_SERVER=OFF `
            -DWITH_CLIENT=ON `
            -DWITH_SAMPLE=OFF `
            -DWITH_CLIENT_SDL=OFF `
            -DWITH_CUPS=OFF `
            -DWITH_PCSC=OFF `
            -DWITH_PKCS11=OFF `
            -DWITH_SMARTCARD_EMULATE=OFF `
            -DWITH_SMARTCARD_PCSC=OFF `
            -DWITH_FFMPEG=OFF `
            -DWITH_SWSCALE=OFF `
            -DWITH_GFX_H264=OFF `
            -DWITH_VIDEO_FFMPEG=OFF `
            -DWITH_DSP_FFMPEG=OFF `
            -DWITH_JPEG=OFF `
            -DWITH_WEBVIEW=OFF `
            -DWITH_AAD=OFF `
            -DWITH_LODEPNG=OFF `
            -DWITH_DEBUG_ALL=OFF `
            -DWITH_SDL=OFF `
            -DWITH_OPUS=OFF `
            -DWITH_OPENSSL=ON
          cmake --build . --config Release
          cmake --install . --config Release

      - name: Update binding.gyp for Windows
        run: |
          @"
          {
              "targets": [{
                  "target_name": "node-freerdp",
                  "sources": ["context.cc", "generator.cc", "rdp.cc", "bridge.cc", "node-freerdp.cc"],
                  "include_dirs": [
                      "<!(node -e \"require('nan')\")",
                      "${{ github.workspace }}\freerdp-static\include\freerdp3",
                      "${{ github.workspace }}\freerdp-static\include\winpr3"
                  ],
                  "libraries": [
                      "${{ github.workspace }}\freerdp-static\lib\freerdp-client3.lib",
                      "${{ github.workspace }}\freerdp-static\lib\freerdp3.lib",
                      "${{ github.workspace }}\freerdp-static\lib\winpr3.lib",
                      "libssl.lib",
                      "libcrypto.lib",
                      "crypt32.lib",
                      "secur32.lib",
                      "ws2_32.lib"
                  ]
              }]
          }
          "@ | Out-File -encoding ASCII binding.gyp

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build node addon
        run: |
          npm install
          npm run install

      - name: Create package
        run: |
          mkdir dist\win32-x64
          copy build\Release\node-freerdp.node dist\win32-x64\
          copy README.md dist\win32-x64\ 2>$null
          @"
          {
            "name": "node-freerdp",
            "version": "${{ github.ref_name }}",
            "os": "win32",
            "arch": "x64",
            "main": "node-freerdp.node"
          }
          "@ | Out-File -encoding ASCII dist\win32-x64\package.json
          tar -czf node-freerdp-win32-x64.tar.gz -C dist\win32-x64 .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: node-freerdp-win32-x64
          path: node-freerdp-win32-x64.tar.gz

  release:
    needs: [build-mac-x64, build-mac-arm, build-linux-x64, build-linux-arm, build-windows-x64]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/node-freerdp-macos-x64/*.tar.gz
            artifacts/node-freerdp-macos-arm64/*.tar.gz
            artifacts/node-freerdp-linux-x64/*.tar.gz
            artifacts/node-freerdp-linux-arm64/*.tar.gz
            artifacts/node-freerdp-win32-x64/*.tar.gz
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
